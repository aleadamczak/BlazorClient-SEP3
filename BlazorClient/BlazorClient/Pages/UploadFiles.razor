@page "/UploadFiles"
@using Google.Protobuf
@using BlazorClient.gRPCClients.Interfaces

@inject IUserService UsergRpcClient
@inject IFileService FilegRpcClient;
<h3>UploadFiles</h3>



<MudTextField @bind-Value="Title" Label="Title" Variant="Variant.Text"></MudTextField>
<MudTextField @bind-Value="Description" Label="File Description" Variant="Variant.Text"></MudTextField>
<MudTextField @bind-Value="Username" Label="Username" Variant="Variant.Text"></MudTextField>
<InputFile OnChange="@LoadFiles" />
<MudButton OnClick="@CreateAsync" Variant="Variant.Filled" Color="Color.Primary"> Submit File </MudButton>

@if (!string.IsNullOrEmpty(message))
{
    <div>
        <span>@message</span>
    </div>
}

@code {

    private IBrowserFile? file;
    private string Title { get; set; } = "";
    private string Description { get; set; } = "";
    private string Username { get; set; } = "";
    private string message = "";
    private string contentType { get; set; } = "";

    private void LoadFiles(InputFileChangeEventArgs e)
    {
        file = e.GetMultipleFiles().FirstOrDefault();
        contentType = file.ContentType;
    }

    private async void CreateAsync()
    {
       
        if (file != null)

        {
            byte[] bytes = new byte[file.Size]; 
            using (var ms = new MemoryStream())
            {
                await file.OpenReadStream().CopyToAsync(ms);
                bytes = ms.ToArray();
            }

            try
            {
                // User? existing = UserService.GetByUsernameAsync(Username);
                var newFile = new FileCreationDto()
                {
                    Title = Title,
                    Description = Description,
                    Bytes = ByteString.CopyFrom(bytes),
                    UploadedBy = await UsergRpcClient.GetByUsernameAsync(Username),
                    ContentType = contentType,
                    Category = new Category()
                    {
                        Name = "opsa"
                    }
                };
                
                await FilegRpcClient.CreateAsync(newFile);
            }
            catch (Exception e)
            {
                Console.WriteLine(e);
                message = e.Message;
            }


            Console.WriteLine("File sent to the service");
        }
    }

}
